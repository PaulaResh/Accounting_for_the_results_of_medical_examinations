'''
Главный модуль программы 'Учёт результатов диспансеризации'.
Программа для учета медицинских осмотров в детском саду.
'''

from database import load_database, save_database, add_record, edit_record, delete_record
from utils import print_record, clear_screen, print_records_table


def show_main_menu():
    '''
    Отображает главное меню программы.

    Returns:
        str: Выбор пользователя
    '''
    print('\n' + '=' * 60)
    print('УЧЕТ РЕЗУЛЬТАТОВ ДИСПАНСЕРИЗАЦИИ')
    print('=' * 60)
    print('\nГЛАВНОЕ МЕНЮ:')
    print('1. Просмотреть базу данных')
    print('2. Добавить новую запись')
    print('3. Редактировать запись')
    print('4. Удалить запись')
    print('5. Создать отчеты')
    print('6. Сохранить данные')
    print('7. Выход')

    return input('\nВаш выбор (1-7): ').strip()


def show_reports_menu(records):
    '''
    Отображает меню отчетов и обрабатывает выбор пользователя.

    Args:
        records (list): Список записей
    '''
    while True:
        clear_screen()
        print('\n' + '=' * 60)
        print('СОЗДАНИЕ ОТЧЕТОВ')
        print('=' * 60)
        print('\nВыберите отчет:')
        print('1. Полный отчет (сортировка по здоровым заключениям)')
        print('2. Отчет по группе (сортировка по дате рождения)')
        print('3. Отчет по детям, нуждающимся в лечении')
        print('0. Вернуться в главное меню')

        choice = input('\nВаш выбор (0-3): ').strip()

        if choice == '0':
            break
        elif choice == '1':
            from reports import generate_full_report
            generate_full_report(records)
        elif choice == '2':
            from reports import generate_group_report
            generate_group_report(records)
        elif choice == '3':
            from reports import generate_treatment_report
            generate_treatment_report(records)
        else:
            print('Неверный выбор. Попробуйте снова.')
            input('Нажмите Enter для продолжения...')


def view_database(records):
    '''
    Просмотр базы данных в виде таблицы.

    Args:
        records (list): Список записей
    '''
    if not records:
        print('База данных пуста.')
        input('\nНажмите Enter для продолжения...')
        return

    while True:
        clear_screen()

        print_records_table(records, 'ВСЕ ЗАПИСИ БАЗЫ ДАННЫХ')

        print('\n' + '=' * 80)
        print('КОМАНДЫ:')
        print('  номер - просмотреть запись подробно')
        print('  0     - вернуться в главное меню')

        choice = input('\nВаш выбор: ').strip().lower()

        if choice == '0':
            break
        else:
            try:
                index = int(choice) - 1
                if 0 <= index < len(records):
                    clear_screen()
                    print_record(records[index], index + 1)
                    input('\nНажмите Enter для продолжения...')
                else:
                    print('Неверный номер записи.')
                    input('Нажмите Enter для продолжения...')
            except ValueError:
                print('Неверный ввод.')
                input('Нажмите Enter для продолжения...')


def create_sample_data():
    '''
    Создает пример данных для тестирования программы.

    Returns:
        list: Список тестовых записей
    '''
    print('\nСоздание тестовой базы данных...')

    # Тестовые данные (30 записей для демонстрации сортировок)
    test_records = [
        # Старшая группа (2018-2019)
        {'фамилия': 'Иванов', 'имя': 'Алексей', 'дата_рождения': '2018-05-15',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'здоров'},

        {'фамилия': 'Петрова', 'имя': 'Мария', 'дата_рождения': '2019-08-22',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'здоров'},

        {'фамилия': 'Сидоров', 'имя': 'Дмитрий', 'дата_рождения': '2019-01-10',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'здоров'},

        # Старшая группа с разными заключениями
        {'фамилия': 'Кузнецов', 'имя': 'Андрей', 'дата_рождения': '2018-11-03',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Абрамова', 'имя': 'Елена', 'дата_рождения': '2019-12-25',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'здоров'},

        {'фамилия': 'Белов', 'имя': 'Сергей', 'дата_рождения': '2018-03-18',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'здоров', 'окулист': 'здоров'},

        # Средняя группа (2020-2021)
        {'фамилия': 'Григорьева', 'имя': 'Ольга', 'дата_рождения': '2020-07-07',
         'группа': 'средняя', 'невропатолог': 'здоров', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Дмитриев', 'имя': 'Павел', 'дата_рождения': '2021-09-14',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Ефимова', 'имя': 'Ирина', 'дата_рождения': '2020-02-28',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'здоров', 'окулист': 'здоров'},

        # Средняя группа
        {'фамилия': 'Жуков', 'имя': 'Владимир', 'дата_рождения': '2021-04-12',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'здоров'},

        {'фамилия': 'Зайцева', 'имя': 'Наталья', 'дата_рождения': '2020-06-30',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Ильин', 'имя': 'Максим', 'дата_рождения': '2021-11-05',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        # Младшая группа (2022-2023)
        {'фамилия': 'Ковалева', 'имя': 'Анна', 'дата_рождения': '2022-08-19',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Лебедев', 'имя': 'Александр', 'дата_рождения': '2023-10-08',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Михайлова', 'имя': 'Виктория', 'дата_рождения': '2022-07-23',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        # Старшая группа
        {'фамилия': 'Антонов', 'имя': 'Игорь', 'дата_рождения': '2019-12-01',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'здоров'},

        {'фамилия': 'Борисова', 'имя': 'Ксения', 'дата_рождения': '2018-03-15',
         'группа': 'старшая', 'невропатолог': 'здоров', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'здоров', 'окулист': 'здоров'},

        # Средняя группа
        {'фамилия': 'Васильев', 'имя': 'Артем', 'дата_рождения': '2021-09-09',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Герасимова', 'имя': 'Татьяна', 'дата_рождения': '2020-02-14',
         'группа': 'средняя', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Данилов', 'имя': 'Роман', 'дата_рождения': '2021-04-20',
         'группа': 'средняя', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Егорова', 'имя': 'Светлана', 'дата_рождения': '2020-08-11',
         'группа': 'средняя', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        # Младшая группа
        {'фамилия': 'Федоров', 'имя': 'Никита', 'дата_рождения': '2023-12-25',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Яковлева', 'имя': 'Юлия', 'дата_рождения': '2022-06-18',
         'группа': 'младшая', 'невропатолог': 'здоров', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Кириллов', 'имя': 'Антон', 'дата_рождения': '2023-01-30',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Ларина', 'имя': 'Екатерина', 'дата_рождения': '2022-05-05',
         'группа': 'младшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'здоров', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Морозов', 'имя': 'Денис', 'дата_рождения': '2023-10-10',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Новикова', 'имя': 'Оксана', 'дата_рождения': '2022-03-22',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Орлов', 'имя': 'Станислав', 'дата_рождения': '2023-07-17',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'},

        {'фамилия': 'Павлова', 'имя': 'Маргарита', 'дата_рождения': '2022-09-28',
         'группа': 'младшая', 'невропатолог': 'здоров', 'отоларинголог': 'здоров',
         'ортопед': 'нуждается в лечении', 'окулист': 'здоров'},

        {'фамилия': 'Романова', 'имя': 'Валерия', 'дата_рождения': '2023-04-04',
         'группа': 'младшая', 'невропатолог': 'нуждается в лечении', 'отоларинголог': 'нуждается в лечении',
         'ортопед': 'нуждается в лечении', 'окулист': 'нуждается в лечении'}
    ]

    return process_records_batch(test_records)


def main():
    '''Основная функция программы.'''
    clear_screen()
    print('ЗАГРУЗКА ДАННЫХ...')

    # Загрузка данных из файла
    records, message = load_database()
    print(message)

    # Если файл не найден, предлагаем создать тестовые данные
    if not records and 'не найден' in message:
        create_sample = input('\nСоздать тестовую базу данных? (да/нет): ').strip().lower()
        if create_sample in ['да', 'д', 'y', 'yes']:
            records = create_sample_data()
            save_message = save_database(records)
            print(save_message)

    # Основной цикл программы
    while True:
        clear_screen()
        choice = show_main_menu()

        if choice == '1':
            # Просмотр базы данных
            view_database(records)

        elif choice == '2':
            # Добавление новой записи
            records, message = add_record(records)
            print(message)
            input('\nНажмите Enter для продолжения...')

        elif choice == '3':
            # Редактирование записи
            records, message = edit_record(records)
            print(message)
            input('\nНажмите Enter для продолжения...')

        elif choice == '4':
            # Удаление записи
            records, message = delete_record(records)
            print(message)
            input('\nНажмите Enter для продолжения...')

        elif choice == '5':
            # Создание отчетов
            show_reports_menu(records)

        elif choice == '6':
            # Сохранение данных
            message = save_database(records)
            print(message)
            input('\nНажмите Enter для продолжения...')

        elif choice == '7':
            # Выход
            print('\nСохранение данных перед выходом...')
            save_message = save_database(records)
            print(save_message)
            print('\nДо свидания!')
            break

        else:
            print('Неверный выбор. Попробуйте снова.')
            input('Нажмите Enter для продолжения...')


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print('\n\nПрограмма прервана пользователем.')
    except Exception as e:
        print(f'\nКритическая ошибка: {e}')
        print('Пожалуйста, сообщите об ошибке разработчику.')
